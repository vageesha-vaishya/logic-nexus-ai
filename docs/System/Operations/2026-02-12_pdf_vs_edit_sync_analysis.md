# Critical Incident Analysis: Quote PDF vs. Edit Mode Data Discrepancy

**Reference:** MGL-SYS-1770819021371  
**Date:** 2026-02-12  
**Status:** Resolved

## 1. Executive Summary
A critical data synchronization issue was reported where the PDF generated for quote `MGL-SYS-1770819021371` displayed complete and accurate data, while the "Edit Quote" and "Quotation Composer" forms loaded with empty fields (missing items, cargo, and options).

**Root Cause:** The PDF generation service runs with elevated **Service Role** privileges (bypassing Row Level Security), whereas the frontend application uses **User Session** privileges. The frontend failed to load child entities (`quote_items`) due to RLS policies and inconsistent tenant scoping in the data access layer.

**Resolution:** The frontend data access layer (`useQuoteRepository.ts`) was refactored to use the tenant-aware `scopedDb` client, ensuring consistent access patterns that align with RLS policies. Robust error handling was added to prevent partial data loading.

---

## 2. Root Cause Analysis

### 2.1 PDF Generation Mechanism
The PDF is generated by the `generate-quote-pdf` Edge Function.
- **Entry Point:** `supabase/functions/generate-quote-pdf/index.ts`
- **Infrastructure:** Uses `serveWithLogger` middleware from `supabase/functions/_shared/logger.ts`.
- **Privileges:** `serveWithLogger` initializes the Supabase client using `SUPABASE_SERVICE_ROLE_KEY`.
  ```typescript
  // supabase/functions/_shared/logger.ts
  const supabaseUrl = Deno.env.get('SUPABASE_URL') ?? '';
  const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? '';
  const supabase = createClient(supabaseUrl, supabaseKey);
  ```
- **Result:** The PDF generator bypasses all RLS checks and tenant filters, effectively having "God Mode" access to the database. This explains why the PDF always shows complete data.

### 2.2 Edit Mode (Frontend) Mechanism
The Edit Quote form uses the `useQuoteRepositoryForm` hook.
- **File:** `src/components/sales/quote-form/useQuoteRepository.ts`
- **Previous Implementation:** Used the global `supabase` client directly.
  ```typescript
  // OLD CODE
  const { data: items } = await supabase.from('quote_items').eq('quote_id', id);
  ```
- **Privileges:** Runs with the authenticated user's JWT. Subject to strict RLS policies.
- **Failure Mode:**
  1.  **RLS Blocking:** The RLS policy for `quote_items` likely enforces strict tenant checks (`tenant_id = current_tenant`).
  2.  **Context Mismatch:** If the global client was used without explicitly filtering by `tenant_id` (or if the user's session context didn't match the quote's tenant), the RLS policy would return 0 rows.
  3.  **Silent Failure:** The application loaded the Quote Header (which might have more permissive "view" policies) but failed to load Items. The form rendered with the Quote Number but empty item lists.

### 2.3 The Discrepancy
| Feature | Client | Auth Context | RLS Status | Result |
| :--- | :--- | :--- | :--- | :--- |
| **PDF Generation** | Edge Function | **Service Role** | **Bypassed** | ✅ Full Data Access |
| **Edit Quote** | React Frontend | **User JWT** | **Enforced** | ❌ Blocked (Items Hidden) |

---

## 3. Technical Investigation & Fix

### 3.1 Fix Implementation
We aligned the frontend data access with the application's multi-tenant architecture by replacing the global `supabase` client with the `scopedDb` helper.

**File:** `src/components/sales/quote-form/useQuoteRepository.ts`

**Changes:**
1.  **Switch to `scopedDb`:**
    ```typescript
    // NEW CODE
    const { scopedDb } = useCRM();
    const { data: items } = await scopedDb.from('quote_items').eq('quote_id', id);
    ```
    `scopedDb` automatically appends `.eq('tenant_id', currentTenantId)` and handles admin overrides, ensuring the query matches the RLS expectations.

2.  **Partial Failure Protection:**
    Added strict validation. If the Quote loads but Items fail (returning null or error), the hook now throws an error instead of returning an empty list. This prevents the "Empty Form" state which could lead to accidental data loss if the user clicked "Save".

### 3.2 Verification
We verified the fix using two scripts:

1.  **`scripts/diagnose_quote_data.ts`**: Confirmed the data exists and belongs to Tenant `fbb1e554...`.
2.  **`scripts/integration_test_quote_flow.ts`**:
    - Created a test quote.
    - Fetched it using the new `scopedDb` logic (simulating Edit Mode).
    - Verified items were retrieved correctly.
    - Updated the quote using the atomic RPC save.
    - Verified data integrity.

## 4. Conclusion
The issue is resolved. The frontend now correctly respects the tenant context and RLS policies, matching the data availability seen in the PDF (within the user's permitted scope). Users in the correct tenant can now edit the quote without issue.

**Recommendations:**
- Ensure users attempting to edit quotes are logged into the correct tenant (or franchise) context.
- Avoid using the global `supabase` client for fetching sensitive business entities; always use `useCRM().scopedDb`.
