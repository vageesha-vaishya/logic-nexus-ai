# Data Seeding for Port Locations

## Overview
This document details the comprehensive data seeding solution for the `port_locations` table. The solution populates the database with a robust dataset of over 200 global locations, including USA/International ports, airports, and railway terminals, ensuring high accuracy and standard compliance.

## Data Sources & Appendices

The data compilation methodology adheres to strict international standards and incorporates the following authoritative sources:

### Appendix D - Export Port Codes
We utilize the **Schedule D** (Customs District and Port Codes) for validating USA export port codes. This ensures that all US-based locations (seaports, airports, and railway terminals) align with U.S. Census Bureau and CBP (Customs and Border Protection) standards.
*   **Coverage**: All major US Customs Districts.
*   **Usage**: Validation of `location_code` for US entities.

### Schedule K - Classification of Foreign Ports
For international locations, we align with **Schedule K** (Classification of Foreign Ports by Geographic Trade Area and Country).
*   **Coverage**: Major international seaports and airports across Asia, Europe, Americas, and Oceania.
*   **Usage**: Standardization of `country`, `location_name`, and geographic grouping.

### Appendix Z – Additional Information Sources
Supplementary data points are derived from:
*   **IATA (International Air Transport Association)**: For 3-letter airport codes.
*   **UN/LOCODE (United Nations Code for Trade and Transport Locations)**: For standardizing 5-character location codes (e.g., USNYC).
*   **ICAO**: For 4-letter airport codes (referenced in `notes` where applicable).

## Validation Procedures & Quality Assurance

To ensure data integrity, a multi-layered validation process is implemented within the generation script (`scripts/generate_ports_migration.js`):

1.  **AI-Powered Verification**:
    *   Data is cross-referenced using LLM technologies to verify the existence and active status of ports.
    *   **Confidence Score**: > 0.95 (Threshold for inclusion).
    *   *Note*: Entries below this confidence threshold are automatically excluded.

2.  **Schema Validation**:
    *   **Code Format**: Regex validation `^[A-Z0-9-]{3,10}$` to ensure standard compliance.
    *   **Coordinates**: Numeric validation for `lat` (-90 to 90) and `lng` (-180 to 180).
    *   **Required Fields**: Strict checks for `name`, `code`, `type`, and `country`.

3.  **Deduplication & Idempotency**:
    *   **Deduplication**: Source data is deduplicated by `location_code`.
    *   **Idempotency**: SQL generation uses `INSERT ... SELECT ... WHERE NOT EXISTS`, allowing safe re-runs without duplicate errors.

4.  **Data Sanitization**:
    *   All string inputs are escaped to prevent SQL injection.
    *   JSONB coordinates are formatted strictly.

5.  **Standards Compliance**:
    *   **IATA**: Airports include `iata_code` (3-letter).
    *   **ICAO**: Optional `icao_code` (4-letter) when available.
    *   **UN/LOCODE**: Seaports include `un_locode` (5-character).
    *   **Country Codes**: `country_code` standardized (ISO-3166).

6.  **Hierarchy Links**:
    *   Links to `countries.id` and `cities.id` are set when available, enabling queries like country → region → city → facility.

## Included Data Types

*   **Seaports**: Major coastal and inland ports (e.g., Port of Los Angeles, Port of Rotterdam, Port of Tema).
*   **Airports**: International cargo and passenger hubs (e.g., JFK, Heathrow, Dubai).
*   **Railway Terminals**: Major US and Canadian rail hubs (e.g., Chicago Rail Terminal, Toronto Rail Terminal). *Note: Requires `railway_terminal` added to `location_type` enum.*

## Maintenance & Updates

### How to Run
The migration file is automatically generated by the script `scripts/generate_ports_migration.js`.

1.  **Generate the Migration File**:
    ```bash
    node scripts/generate_ports_migration.js
    ```
    *Output*: `supabase/migrations/20260130121000_seed_ports_locations_v2.sql`

2.  **Apply the Migration**:
    ```bash
    supabase migration up
    ```

### Rollback Mechanism
In the event of data corruption or incorrect seeding:
1.  **Identification**: Identify the corrupted batch or entries via the `notes` field (e.g., `Global seed - AI Generated`).
2.  **Reversion**: Execute a targeted delete command:
    ```sql
    DELETE FROM public.ports_locations 
    WHERE notes LIKE '%Global seed - AI Generated%' 
    AND tenant_id IS NULL;
    ```
3.  **Correction**: Fix the source data in `scripts/generate_ports_migration.js` and re-run the generation script.

## Master Data Management (MDM) Strategy
*   **Global Scope**: Seeded entities are `tenant_id = NULL`, serving as the "Golden Record" for all tenants.
*   **Immutability**: Tenants should not modify global records directly. Tenant-specific overrides should be handled via separate tables or specific `tenant_id` entries that shadow the global codes (application logic dependent).

## Verification Queries
Use the following checks after seeding:
```sql
-- Basic counts
SELECT location_type, COUNT(*) FROM public.ports_locations WHERE tenant_id IS NULL GROUP BY 1 ORDER BY 1;

-- Standards compliance
SELECT COUNT(*) FROM public.ports_locations WHERE iata_code IS NOT NULL AND iata_code !~ '^[A-Z]{3}$';
SELECT COUNT(*) FROM public.ports_locations WHERE icao_code IS NOT NULL AND icao_code !~ '^[A-Z]{4}$';
SELECT COUNT(*) FROM public.ports_locations WHERE un_locode IS NOT NULL AND un_locode !~ '^[A-Z]{2}[A-Z0-9]{3}$';

-- Hierarchy linkage coverage
SELECT COUNT(*) FROM public.ports_locations WHERE country_id IS NOT NULL;
SELECT COUNT(*) FROM public.ports_locations WHERE city_id IS NOT NULL;
```
